<turbo-frame id="approval_modal">
<div class="relative z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true" 
     data-controller="approval-wizard"
     data-approval-wizard-return-url-value="<%= bl_house_lines_path %>"
     data-approval-wizard-initial-step-value="<%= (bl_house_line.errors.any? || params[:decision] == 'assign') ? 2 : 1 %>">
  <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>

  <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
      <div class="fixed inset-0" data-action="click->approval-wizard#close"></div>
      <div class="relative transform overflow-hidden rounded-3xl bg-white text-left shadow-[0_24px_48px_-12px_rgba(79,70,229,0.35)] ring-1 ring-black/5 transition-all sm:my-12 sm:w-full sm:max-w-4xl">
        <div class="absolute right-0 top-0 hidden pr-4 pt-4 sm:block">
          <button type="button" class="rounded-full p-2 text-slate-400 transition hover:bg-slate-100 hover:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2" data-action="click->approval-wizard#close">
            <span class="sr-only">Cerrar</span>
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div id="step_content" class="flex flex-col gap-8">
          <% container = bl_house_line.container %>
          <% tarja_present = container&.tarja_documento&.attached? %>
          <% requesting_agent = (@requesting_agent || bl_house_line.customs_agent) %>
          <% assigned_agency = requesting_agent || bl_house_line.customs_agent %>
          <% available_agents = (@customs_agents || Entity.customs_agents.order(:name)).to_a %>
          <% if requesting_agent.present? %>
            <% available_agents.delete_if { |agent| agent.id == requesting_agent.id } %>
            <% available_agents.unshift(requesting_agent) %>
          <% end %>
          <% agent_options = available_agents.map do |agent|
               label = agent.name
               label += " (solicitante)" if requesting_agent.present? && agent.id == requesting_agent.id
               [label, agent.id]
             end %>
          <% broker_links = AgencyBroker.includes(:broker).where(agency_id: available_agents.map(&:id)) %>
          <% broker_options = broker_links.map do |link|
               broker = link.broker
               label = "#{broker.name} - Patente #{broker.patent_number}"
               [label, broker.id, { data: { group: link.agency_id.to_s } }]
             end %>

           <%= form_with model: bl_house_line, url: approve_revalidation_bl_house_line_path(bl_house_line), method: :patch, id: "approval_form", html: { class: "flex flex-col" } do |f| %>

             <% if bl_house_line.errors.any? %>
              <div class="mx-6 mt-6 rounded-xl border border-red-100 bg-red-50/80 p-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Resuelve los campos pendientes</h3>
                    <div class="mt-2 text-sm text-red-700">
                      <ul role="list" class="list-disc space-y-1 pl-5">
                        <% bl_house_line.errors.full_messages.each do |msg| %>
                          <li><%= msg %></li>
                        <% end %>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
             <% end %>

             <div data-approval-wizard-target="step1" class="px-6 py-8 sm:py-10">
                <div class="flex items-start justify-between gap-4 border-b border-slate-100 pb-6">
                  <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-indigo-500">Paso 1</p>
                    <h3 class="text-2xl font-semibold text-slate-900" id="modal-title">Validar documentación</h3>
                    <p class="mt-1 text-sm text-slate-500">Revisa cada archivo y confirma si cumple los requisitos o solicita correcciones.</p>
                  </div>
                  <div class="flex items-center gap-2 rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold text-indigo-600">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Revisión requerida
                  </div>
                </div>

                <div class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3">
                  <% [ :bl_endosado_documento, :liberacion_documento, :encomienda_documento, :pago_documento ].each do |doc| %>
                    <% document_attached = bl_house_line.send(doc).attached? %>
                    <% validated = bl_house_line.document_validated?(doc) %>
                    <div class="group relative overflow-hidden rounded-2xl border border-slate-100 bg-slate-50/60 p-4 shadow-sm transition hover:shadow-lg">
                      <div class="flex items-center justify-between gap-3">
                        <div class="flex items-center gap-3">
                          <div class="flex h-9 w-9 items-center justify-center rounded-full bg-indigo-100 text-indigo-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c.5304 0 1.0391-.2107 1.4142-.5858C13.7893 10.0391 14 9.5304 14 9s-.2107-1.0391-.5858-1.4142C13.0391 7.2107 12.5304 7 12 7s-1.0391.2107-1.4142.5858C10.2107 7.9609 10 8.4696 10 9s.2107 1.0391.5858 1.4142C10.9609 10.7893 11.4696 11 12 11z" />
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 14v2a2.5 2.5 0 01-2.5 2.5h-10A2.5 2.5 0 014.5 16v-2" />
                            </svg>
                          </div>
                          <h4 class="text-sm font-semibold text-slate-900"><%= doc.to_s.humanize.gsub('_', ' ').titleize %></h4>
                        </div>
                        <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-[11px] font-semibold <%= validated ? 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-100' : 'bg-slate-100 text-slate-600' %>">
                          <span class="h-2 w-2 rounded-full <%= validated ? 'bg-emerald-500' : 'bg-slate-400' %>"></span>
                          <%= validated ? 'Validado' : 'Sin validar' %>
                        </span>
                      </div>

                      <div class="mt-4 space-y-3">
                        <% if document_attached %>
                          <%= link_to "Ver documento", rails_blob_path(bl_house_line.send(doc), disposition: "preview"), target: "_blank", class: "inline-flex items-center justify-center gap-2 rounded-full bg-white px-3 py-1.5 text-xs font-semibold text-indigo-600 shadow-sm ring-1 ring-inset ring-indigo-100 transition hover:bg-indigo-50 hover:text-indigo-700" %>
                        <% else %>
                          <span class="inline-flex items-center gap-2 rounded-full bg-amber-100 px-3 py-1.5 text-xs font-semibold text-amber-700">
                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 5a7 7 0 00-7 7v3a2 2 0 002 2h10a2 2 0 002-2v-3a7 7 0 00-7-7z" />
                            </svg>
                            No adjunto
                          </span>
                        <% end %>

                        <% if current_user.admin_or_executive? %>
                          <div class="flex items-center gap-2 rounded-xl bg-white px-3 py-2 text-sm text-slate-700 ring-1 ring-slate-100">
                            <%= hidden_field_tag "bl_house_line[#{doc}_validated]", 0 %>
                            <%= check_box_tag "bl_house_line[#{doc}_validated]", 1, validated, class: "h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500", data: { approval_wizard_target: "validation", action: "change->approval-wizard#updateContinueState" } %>
                            <label class="text-sm font-medium text-slate-800">Marcar como validado</label>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>

                  <!-- TELEX toggle card -->
                  <div class="group relative overflow-hidden rounded-2xl border border-slate-100 bg-white p-4 shadow-sm transition hover:shadow-lg">
                    <div class="flex items-center justify-between gap-3">
                      <div class="flex items-center gap-3">
                        <div class="flex h-9 w-9 items-center justify-center rounded-full bg-indigo-100 text-indigo-600">
                          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c.5304 0 1.0391-.2107 1.4142-.5858C13.7893 10.0391 14 9.5304 14 9s-.2107-1.0391-.5858-1.4142C13.0391 7.2107 12.5304 7 12 7s-1.0391.2107-1.4142.5858C10.2107 7.9609 10 8.4696 10 9s.2107 1.0391.5858 1.4142C10.9609 10.7893 11.4696 11 12 11z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 14v2a2.5 2.5 0 01-2.5 2.5h-10A2.5 2.5 0 014.5 16v-2" />
                          </svg>
                        </div>
                        <h4 class="text-sm font-semibold text-slate-900">Bl House Original</h4>
                      </div>
                      <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600">Opcional</span>
                    </div>

                    <div class="mt-4 flex items-start gap-3 rounded-xl bg-slate-50 px-3 py-2 text-sm text-slate-700 ring-1 ring-slate-100">
                      <%= f.check_box :telex, class: "h-4 w-4 rounded border-indigo-300 text-indigo-600 focus:ring-indigo-500" %>
                      <div>
                        <%= f.label :telex, "Bl House Original", class: "text-sm font-medium text-slate-800" %>
                        <p class="text-xs text-slate-600">Marca si requiere Bl House Original.</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mt-8 rounded-2xl border border-slate-100 bg-white/80 p-5 shadow-sm">
                  <div class="space-y-2">
                     <%= label_tag :observations, "Observaciones (solo si se rechaza)", class: "text-sm font-medium text-slate-700" %>
                     <%= text_area_tag :observations, nil, class: "w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700 transition focus:border-indigo-500 focus:bg-white focus:outline-none focus:ring-4 focus:ring-indigo-100", rows: 3, required: true %>
                  </div>

                  <div class="mt-6 flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
                    <%= button_tag name: "decision", value: "reject", type: "submit", class: "cursor-pointer inline-flex w-full items-center justify-center gap-2 rounded-full border border-slate-200 px-4 py-2.5 text-sm font-semibold text-slate-600 shadow-sm transition hover:border-slate-300 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 sm:w-auto", data: { action: "click->approval-wizard#confirmReject" } do %>
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                      Instrucciones pendientes
                    <% end %>

                    <button type="button" class="cursor-pointer inline-flex w-full items-center justify-center gap-2 rounded-full bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white shadow-md transition hover:bg-indigo-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 sm:w-auto disabled:opacity-60 disabled:cursor-not-allowed" data-approval-wizard-target="continueButton" data-action="click->approval-wizard#handleNext">
                      Continuar con asignación
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                      </svg>
                    </button>
                  </div>
                </div>
             </div>

             <div data-approval-wizard-target="step2" class="hidden px-6 pb-10 sm:pb-12"
                 data-controller="dependent-select" 
                 data-dependent-select-param-value="id">
                <div class="flex items-center justify-between border-b border-slate-100 pb-6">
                  <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-indigo-500">Paso 2</p>
                    <h3 class="text-2xl font-semibold text-slate-900">Asignar Agente y confirmar patente</h3>
                    <p class="mt-1 text-sm text-slate-500">Selecciona al agente aduanal. Si no existe tarja, define fecha tentativa y turno.</p>
                  </div>
                  <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600">2 de 2</span>
                </div>

                 <div class="mt-6 space-y-6">
                    <div class="grid grid-cols-1 gap-5 md:grid-cols-2">
                        <div class="space-y-2">
                          <%= f.label :customs_agent_id, "Agencia Aduanal", class: "text-sm font-medium text-slate-700" %>
                          <% if assigned_agency.present? %>
                            <div class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-800">
                              <%= assigned_agency.name %>
                            </div>
                            <%= hidden_field_tag "bl_house_line[customs_agent_id]", assigned_agency.id, id: "bl_house_line_customs_agent_id", data: { dependent_select_target: "source" } %>
                          <% else %>
                            <%= select_tag "bl_house_line[customs_agent_id]",
                              options_for_select(agent_options, bl_house_line.customs_agent_id),
                              class: "w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-800 transition focus:border-indigo-500 focus:bg-white focus:outline-none focus:ring-4 focus:ring-indigo-100",
                              data: { dependent_select_target: "source", action: "change->dependent-select#filter" },
                              required: true,
                              id: "bl_house_line_customs_agent_id"
                            %>
                          <% end %>
                        </div>
                        <div class="space-y-2">
                          <%= f.label :customs_broker_id, "Agente Aduanal", class: "text-sm font-medium text-slate-700" %>
                          <%= f.select :customs_broker_id,
                            options_for_select(broker_options, bl_house_line.customs_broker_id),
                            { include_blank: "Seleccione un Agente" },
                            class: "w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-800 transition focus:border-indigo-500 focus:bg-white focus:outline-none focus:ring-4 focus:ring-indigo-100",
                            required: true,
                            data: { dependent_select_target: "target" }
                          %>
                        </div>
                    </div>

                      <% if tarja_present %>
                       <div class="flex items-start gap-3 rounded-2xl border border-emerald-100 bg-emerald-50 px-4 py-4 text-sm text-emerald-700 shadow-sm">
                        <svg class="w-5 h-5 flex-shrink-0 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                          <p class="font-semibold">Tarja cargada</p>
                          <p class="text-sm">Al finalizar la aprobación, la partida avanzará directamente a Revalidado y no se solicitará agenda tentativa.</p>
                        </div>
                       </div>
                      <% else %>
                       <div class="grid grid-cols-1 gap-5 md:grid-cols-2">
                         <div class="space-y-2">
                           <%= label_tag :fecha_tentativa_desconsolidacion, "Fecha Tentativa de Desconsolidación", class: "text-sm font-medium text-slate-700" %>
                           <%= date_field_tag :fecha_tentativa_desconsolidacion,
                             bl_house_line.container&.fecha_tentativa_desconsolidacion,
                             required: true,
                             class: "w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-800 transition focus:border-indigo-500 focus:bg-white focus:outline-none focus:ring-4 focus:ring-indigo-100" %>
                         </div>
                         <div class="space-y-2">
                           <%= label_tag :tentativa_turno, "Turno Tentativo", class: "text-sm font-medium text-slate-700" %>
                           <% turno_options = Container.tentativa_turnos.keys.map { |t| [t.tr("_", " ").capitalize, t] } %>
                           <%= select_tag :tentativa_turno,
                             options_for_select(turno_options, bl_house_line.container&.tentativa_turno),
                             class: "w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-800 transition focus:border-indigo-500 focus:bg-white focus:outline-none focus:ring-4 focus:ring-indigo-100" %>
                         </div>
                       </div>
                      <% end %>
                 </div>

                 <div class="mt-8 flex flex-col-reverse gap-3 border-t border-slate-100 pt-6 sm:flex-row sm:justify-end">
                    <button type="button" data-action="click->approval-wizard#close" class="inline-flex w-full items-center justify-center gap-2 rounded-full border border-slate-200 px-4 py-2.5 text-sm font-semibold text-slate-600 shadow-sm transition hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 sm:w-auto">Cancelar</button>
                    
                    <button type="button" data-action="click->approval-wizard#back" class="inline-flex w-full items-center justify-center gap-2 rounded-full border border-slate-200 px-4 py-2.5 text-sm font-semibold text-slate-600 shadow-sm transition hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 sm:w-auto">
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                      </svg>
                      Volver a documentos
                    </button>

                    <%= button_tag name: "decision", value: "assign", type: "submit", class: "cursor-pointer inline-flex w-full items-center justify-center gap-2 rounded-full bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white shadow-md transition hover:bg-indigo-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 sm:w-auto" do %>
                      Finalizar Aprobación
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                      </svg>
                    <% end %>
                 </div>
             </div>

           <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
</turbo-frame>
