<turbo-frame id="approval_modal">
<div class="relative z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true" 
     data-controller="approval-wizard"
     data-approval-wizard-return-url-value="<%= bl_house_lines_path %>"
     data-approval-wizard-initial-step-value="<%= (bl_house_line.errors.any? || params[:decision] == 'assign') ? 2 : 1 %>">
  <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

  <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
      <div class="fixed inset-0" data-action="click->approval-wizard#close"></div>
      <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl sm:p-6">
        <div class="absolute right-0 top-0 hidden pr-4 pt-4 sm:block">
          <button type="button" class="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" data-action="click->approval-wizard#close">
            <span class="sr-only">Cerrar</span>
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <div id="step_content">
           <%= form_with model: bl_house_line, url: approve_revalidation_bl_house_line_path(bl_house_line), method: :patch, id: "approval_form" do |f| %>
             
             <!-- Error Display -->
             <% if bl_house_line.errors.any? %>
              <div class="rounded-md bg-red-50 p-4 mb-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Errors encountered:</h3>
                    <div class="mt-2 text-sm text-red-700">
                      <ul role="list" class="list-disc space-y-1 pl-5">
                        <% bl_house_line.errors.full_messages.each do |msg| %>
                          <li><%= msg %></li>
                        <% end %>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
             <% end %>

             <!-- STEP 1 -->
             <div data-approval-wizard-target="step1">
                <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Validación de Documentos</h3>
                <div class="mt-2">
                  <p class="text-sm text-gray-500">Revise los documentos adjuntos. Si están correctos, proceda a aprobar. Si falta algo, indique instrucciones.</p>
                </div>
                
                <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                  <!-- Documents viewers -->
                  <% [ :bl_endosado_documento, :liberacion_documento, :encomienda_documento, :pago_documento ].each do |doc| %>
                     <div class="border rounded p-2">
                        <h4 class="font-bold text-xs uppercase mb-2"><%= doc.to_s.humanize.gsub('_', ' ').titleize %></h4>
                        <% if bl_house_line.send(doc).attached? %>
                           <%= link_to "Ver Documento", rails_blob_path(bl_house_line.send(doc), disposition: "preview"), target: "_blank", class: "inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
                        <% else %>
                           <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                             No adjunto
                           </span>
                        <% end %>
                     </div>
                  <% end %>
                </div>

                <div class="mt-6 border-t border-gray-100 pt-6">
                      <div class="mb-4">
                         <%= label_tag :observations, "Observaciones (Solo en caso de rechazo)", class: "block text-sm font-medium text-gray-700 mb-1" %>
                         <%= text_area_tag :observations, nil, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", rows: 3, required: true %>
                      </div>

                      <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                        <%= button_tag name: "decision", value: "reject", type: "submit", class: "inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:w-auto" do %>
                          Instrucciones Pendientes
                        <% end %>
                        
                        <button type="button" data-action="click->approval-wizard#next" class="inline-flex w-full justify-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 sm:w-auto">
                          Documentación Correcta ->
                        </button>
                      </div>
                </div>
             </div>

             <!-- STEP 2 -->
             <div data-approval-wizard-target="step2" class="hidden" 
                  data-controller="dependent-select" 
                  data-dependent-select-param-value="id">
                <h3 class="text-base font-semibold leading-6 text-gray-900">Asignar Patente y Fecha</h3>
                <div class="mt-2">
                   <p class="text-sm text-gray-500">Seleccione el agente aduanal, su patente y establezca la fecha tentativa.</p>
                </div>

                 <div class="mt-4 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                           <%= f.label :customs_agent_id, "Agente Aduanal", class: "block text-sm font-medium text-gray-700" %>
                           <% agents = Entity.customs_agents.order(:name) %>
                           <%= f.collection_select :customs_agent_id, agents, :id, :name, 
                               { prompt: "Seleccione Agente" }, 
                               { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                                 required: true,
                                 data: { dependent_select_target: "source", action: "change->dependent-select#filter" } } 
                           %>
                        </div>
                        <div>
                           <%= f.label :customs_agent_patent_id, "Patente de Agente Aduanal", class: "block text-sm font-medium text-gray-700" %>
                           <% 
                              # Pre-fetch all patents for all agents to enable client-side filtering
                              # Group them by agent_id for easy display
                              all_patents = CustomsAgentPatent.includes(:entity).where(entity_id: agents.pluck(:id)).order(:patent_number)
                           %>
                           <select name="bl_house_line[customs_agent_patent_id]" id="bl_house_line_customs_agent_patent_id" 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                   required
                                   data-dependent-select-target="target">
                               <option value="">Seleccione una patente</option>
                               <% all_patents.each do |patent| %>
                                   <option value="<%= patent.id %>" 
                                           data-group="<%= patent.entity_id %>"
                                           <%= 'selected' if bl_house_line.customs_agent_patent_id == patent.id %>>
                                       <%= patent.patent_number %>
                                   </option>
                               <% end %>
                           </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                       <div>
                          <%= label_tag :tentative_date, "Fecha Tentativa", class: "block text-sm font-medium text-gray-700" %>
                          <%= date_field_tag :tentative_date, nil, required: true, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
                       </div>
                       <div>
                          <%= label_tag :time_period, "Horario", class: "block text-sm font-medium text-gray-700" %>
                          <%= select_tag :time_period, options_for_select(["MAÑANA", "TARDE"]), class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
                       </div>
                    </div>
                 </div>

                 <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end gap-3 border-t border-gray-100 pt-6">
                    <button type="button" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:w-auto" onclick="this.closest('.relative.z-50').remove()">Cancelar</button>
                    
                    <button type="button" data-action="click->approval-wizard#back" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:w-auto">
                      <- Volver
                    </button>

                    <%= button_tag name: "decision", value: "assign", type: "submit", class: "inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:w-auto" do %>
                      Finalizar Aprobación
                    <% end %>
                 </div>
             </div>

           <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
</turbo-frame>
