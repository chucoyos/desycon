<% is_customs_agent = current_user.customs_broker? && current_user.entity&.is_customs_agent? %>

<%= form_with(model: bl_house_line, class: "space-y-6") do |form| %>

  <% if bl_house_line.errors.any? %>
    <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4 shadow-sm">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-semibold text-red-800">
            <%= pluralize(bl_house_line.errors.count, "error") %> impidieron guardar esta partida:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside space-y-1">
              <% bl_house_line.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Información Básica -->
  <div class="bg-white shadow-md rounded-xl p-5 sm:p-6 border border-gray-100">
    <div class="flex items-center gap-3 mb-5">
      <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-green-600 shadow-sm">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-gray-900">Información Básica</h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5">
      <% if bl_house_line.container.present? %>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider">BL Master</label>
          <div class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-700 font-mono">
            <%= bl_house_line.container.bl_master.presence || "No especificado" %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider">Número de Contenedor</label>
          <div class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-700 font-mono">
            <%= bl_house_line.container.number %>
          </div>
        </div>
      <% else %>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider">BL Master</label>
          <%= text_field_tag :bl_master, params[:bl_master], placeholder: "BL Master...", class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 font-mono" %>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider">Número de Contenedor</label>
          <%= text_field_tag :container_number, params[:container_number], placeholder: "MSCU1234567", class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 font-mono" %>
        </div>
      <% end %>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5">
      <div>
        <%= form.label :blhouse, "BL House *", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.text_field :blhouse, required: true, placeholder: "BLH-001", disabled: is_customs_agent, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 font-mono #{is_customs_agent ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''} #{bl_house_line.errors[:blhouse].any? ? 'border-red-300 focus:ring-red-500 focus:border-red-500' : ''}" %>
        <% if bl_house_line.errors[:blhouse].any? %>
          <p class="mt-1 text-sm text-red-600"><%= bl_house_line.errors[:blhouse].first %></p>
        <% end %>
      </div>

      <div>
        <%= form.label :status, "ESTATUS *", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.select :status, BlHouseLine.statuses.keys.map { |s| [bl_house_line_status_nombre(s), s] }, {}, disabled: is_customs_agent, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 #{is_customs_agent ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''} #{bl_house_line.errors[:status].any? ? 'border-red-300 focus:ring-red-500 focus:border-red-500' : ''}" %>
        <% if bl_house_line.errors[:status].any? %>
          <p class="mt-1 text-sm text-red-600"><%= bl_house_line.errors[:status].first %></p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Información de Agente Aduanal y Cliente -->
  <div class="bg-white shadow-md rounded-xl p-5 sm:p-6 border border-gray-100">
    <div class="flex items-center gap-3 mb-5">
      <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-purple-600 shadow-sm">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-gray-900">Partes Involucradas</h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5">
      <div>
        <%= form.label :customs_agent_id, "Agente Aduanal", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.collection_select :customs_agent_id, @customs_agents, :id, :name, { include_blank: "Seleccionar agente aduanal (opcional)" }, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200" %>
      </div>

      <div>
        <%= form.label :client_id, "Cliente", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.collection_select :client_id, @clients, :id, :name, { include_blank: "Seleccionar cliente (opcional)" }, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200" %>
      </div>
    </div>
  </div>

  <!-- Detalles de Cantidad y Embalaje -->
  <div class="bg-white shadow-md rounded-xl p-5 sm:p-6 border border-gray-100">
    <div class="flex items-center gap-3 mb-5">
      <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-600 shadow-sm">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-gray-900">Detalles de la Carga</h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5">
      <div>
        <%= form.label :cantidad, "Cantidad *", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.number_field :cantidad, required: true, placeholder: "100", min: 1, disabled: is_customs_agent, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 #{is_customs_agent ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''} #{bl_house_line.errors[:cantidad].any? ? 'border-red-300 focus:ring-red-500 focus:border-red-500' : ''}" %>
        <% if bl_house_line.errors[:cantidad].any? %>
          <p class="mt-1 text-sm text-red-600"><%= bl_house_line.errors[:cantidad].first %></p>
        <% end %>
      </div>

      <div>
        <%= form.label :volumen, "Volumen (m³)", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.number_field :volumen, step: "0.01", placeholder: "2.50", min: 0, disabled: is_customs_agent, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 #{is_customs_agent ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''}" %>
      </div>

      <div>
        <%= form.label :packaging_id, "Embalaje
        ", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.collection_select :packaging_id, Packaging.all, :id, :nombre, { include_blank: "Seleccionar embalaje" }, disabled: is_customs_agent, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 #{is_customs_agent ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''}" %>
      </div>

      <div>
        <%= form.label :peso, "Peso (kg)", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.number_field :peso, step: "0.01", placeholder: "150.50", min: 0, disabled: is_customs_agent, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 #{is_customs_agent ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''}" %>
      </div>

      <% if bl_house_line.container_id.present? %>
        <%= form.hidden_field :container_id %>
      <% end %>

      <div class="md:col-span-2">
        <%= form.label :contiene, "Contiene", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.text_area :contiene, rows: 2, placeholder: "Descripción del contenido de la partida", disabled: is_customs_agent, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 resize-vertical #{is_customs_agent ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''}" %>
      </div>

      <div class="md:col-span-2">
        <%= form.label :marcas, "Marcas", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.text_area :marcas, rows: 2, placeholder: "Marcas, números de serie, o identificadores especiales", disabled: is_customs_agent, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 resize-vertical #{is_customs_agent ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''}" %>
      </div>

      <div class="md:col-span-2">
        <%= form.label :observaciones, "Observaciones", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.text_area :observaciones, rows: 3, placeholder: "Observaciones adicionales sobre la partida", disabled: is_customs_agent, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 resize-vertical #{is_customs_agent ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''}" %>
      </div>
    </div>
  </div>

    <!-- Servicios -->
    <% unless is_customs_agent %>
    <div class="bg-white shadow-md rounded-xl p-5 sm:p-6 border border-gray-100">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-0 mb-5">
        <div class="flex items-center gap-3">
          <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-purple-600 shadow-sm">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold text-gray-900">Servicios</h2>
        </div>
        <% unless is_customs_agent %>
          <button type="button" id="add-bl-service" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 shadow-sm hover:shadow-md transition-all duration-200 w-full sm:w-auto">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Agregar Servicio
          </button>
        <% end %>
      </div>

      <div id="bl-services-container" class="space-y-4">
        <%= form.fields_for :bl_house_line_services do |service_form| %>
          <%= render 'service_fields', f: service_form, is_customs_agent: is_customs_agent %>
        <% end %>
      </div>

      <% unless is_customs_agent %>
        <div id="bl-service-template" class="hidden">
          <%= form.fields_for :bl_house_line_services, BlHouseLineService.new(billed_to_entity_id: bl_house_line.client_id), child_index: 'NEW_RECORD' do |service_form| %>
            <%= render 'service_fields', f: service_form, is_customs_agent: is_customs_agent %>
          <% end %>
        </div>
      <% end %>
    </div>
    <% end %>

  <!-- Documentos -->
  <div class="bg-white shadow-md rounded-xl p-5 sm:p-6 border border-gray-100">
    <div class="flex items-center gap-3 mb-5">
      <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-orange-600 shadow-sm">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-gray-900">Documentos</h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-5">
      <div>
        <%= form.label :bl_endosado_documento, "BL Endosado", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.file_field :bl_endosado_documento, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 file:mr-4 file:py-2 file:px-4 file:rounded-l-lg file:border-0 file:text-sm file:font-medium file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100" %>
        <% if bl_house_line.persisted? && bl_house_line.bl_endosado_documento.attached? %>
          <p class="mt-2 text-sm text-gray-600">Documento actual: <%= link_to "Ver documento", rails_blob_path(bl_house_line.bl_endosado_documento, disposition: "inline"), class: "text-green-600 hover:text-green-800 font-medium", target: "_blank" %></p>
        <% end %>
      </div>

      <div>
        <%= form.label :liberacion_documento, "Liberación", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.file_field :liberacion_documento, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 file:mr-4 file:py-2 file:px-4 file:rounded-l-lg file:border-0 file:text-sm file:font-medium file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100" %>
        <% if bl_house_line.persisted? && bl_house_line.liberacion_documento.attached? %>
          <p class="mt-2 text-sm text-gray-600">Documento actual: <%= link_to "Ver documento", rails_blob_path(bl_house_line.liberacion_documento, disposition: "inline"), class: "text-green-600 hover:text-green-800 font-medium", target: "_blank" %></p>
        <% end %>
      </div>

      <div>
        <%= form.label :bl_revalidado_documento, "BL Revalidado", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <% if is_customs_agent %>
          <div class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-500 cursor-not-allowed text-sm">
            No puede adjuntar BL revalidado
          </div>
        <% else %>
          <%= form.file_field :bl_revalidado_documento, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 file:mr-4 file:py-2 file:px-4 file:rounded-l-lg file:border-0 file:text-sm file:font-medium file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100" %>
        <% end %>
        <% if bl_house_line.persisted? && bl_house_line.bl_revalidado_documento.attached? %>
          <p class="mt-2 text-sm text-gray-600">Documento actual: <%= link_to "Ver documento", rails_blob_path(bl_house_line.bl_revalidado_documento, disposition: "inline"), class: "text-green-600 hover:text-green-800 font-medium", target: "_blank" %></p>
        <% end %>
      </div>

      <div>
        <%= form.label :encomienda_documento, "Encomienda", class: "block text-sm font-semibold text-gray-700 mb-2 uppercase tracking-wider" %>
        <%= form.file_field :encomienda_documento, class: "w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 file:mr-4 file:py-2 file:px-4 file:rounded-l-lg file:border-0 file:text-sm file:font-medium file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100" %>
        <% if bl_house_line.persisted? && bl_house_line.encomienda_documento.attached? %>
          <p class="mt-2 text-sm text-gray-600">Documento actual: <%= link_to "Ver documento", rails_blob_path(bl_house_line.encomienda_documento, disposition: "inline"), class: "text-green-600 hover:text-green-800 font-medium", target: "_blank" %></p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Botones flotantes -->
  <div class="sticky bottom-4 sm:bottom-6 mt-8 flex flex-wrap justify-end gap-3 px-4 sm:px-5 py-3 sm:py-4 bg-transparent w-full z-20">
    <% cancel_target = if bl_house_line.persisted?
                         bl_house_line_path(bl_house_line)
                       elsif bl_house_line.container.present?
                         container_path(bl_house_line.container, anchor: 'partidas')
                       else
                         bl_house_lines_path
                       end %>
    <% submit_label = bl_house_line.persisted? ? "Actualizar Partida" : "Crear Partida" %>
    <%= link_to cancel_target, class: "cursor-pointer inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-full border border-slate-200 bg-white text-slate-700 text-sm font-semibold hover:bg-slate-50 transition" do %>
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
      Cancelar
    <% end %>
    <%= form.button type: :submit, class: "cursor-pointer inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-full bg-gradient-to-r from-green-600 to-emerald-600 text-white text-sm font-semibold shadow-md shadow-emerald-100/70 hover:from-green-700 hover:to-emerald-700 transition", data: { turbo_submits_with: submit_label } do %>
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <%= submit_label %>
    <% end %>
  </div>
<% end %>

<script>
  const initBlServices = () => {
    const addServiceBtn = document.getElementById('add-bl-service');
    const servicesContainer = document.getElementById('bl-services-container');
    const serviceTemplate = document.getElementById('bl-service-template');

    if (!servicesContainer || servicesContainer.dataset.initialized === 'true') return;
    servicesContainer.dataset.initialized = 'true';

    if (addServiceBtn && serviceTemplate) {
      addServiceBtn.addEventListener('click', () => {
        const newService = serviceTemplate.innerHTML.replace(/NEW_RECORD/g, Date.now());
        servicesContainer.insertAdjacentHTML('afterbegin', newService);
        const newCard = servicesContainer.firstElementChild;
        if (newCard) {
          newCard.classList.add('service-card-appear');
          newCard.addEventListener('animationend', () => newCard.classList.remove('service-card-appear'), { once: true });
        }
      });
    }

    servicesContainer.addEventListener('click', (e) => {
      if (e.target.closest('.remove-service')) {
        e.preventDefault();
        const serviceCard = e.target.closest('.service-card');
        const isPersisted = serviceCard?.dataset.servicePersisted === 'true';
        if (isPersisted) {
          const confirmed = window.confirm('¿Eliminar este servicio? Los cambios se guardarán al actualizar la partida.');
          if (!confirmed) return;
        }
        const destroyInput = serviceCard.querySelector('input[name*="_destroy"]');

        if (destroyInput) {
          destroyInput.value = '1';
          serviceCard.style.display = 'none';
        } else {
          serviceCard.remove();
        }
      }
    });
  };

  document.addEventListener('turbo:load', initBlServices);
  document.addEventListener('DOMContentLoaded', initBlServices);
</script>
