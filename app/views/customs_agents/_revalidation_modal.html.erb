<turbo-frame id="revalidation_modal">
<div class="fixed inset-0 z-50 flex items-center justify-center p-4" data-controller="revalidation-wizard">
  <div class="absolute inset-0 bg-gray-900/50" aria-hidden="true" data-action="click->revalidation-wizard#close"></div>

  <div class="relative bg-white w-full max-w-3xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden border border-gray-200 flex flex-col">
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100 flex-shrink-0">
      <div>
        <p class="text-xs font-semibold text-indigo-600 uppercase tracking-wide">Revalidaci贸n guiada</p>
        <p class="text-lg font-bold text-gray-900">BL House <%= bl_house_line.blhouse %></p>
        <p class="text-sm text-gray-600">Contenedor <%= bl_house_line.container&.number || 'Sin contenedor' %> - Conteniene: <%= truncate(bl_house_line.contiene.to_s, length: 60) %></p>
      </div>
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700 border border-gray-200">
          Estatus: <%= bl_house_line_status_nombre(bl_house_line.status) %>
        </span>
        <button type="button" class="p-2 rounded-full hover:bg-gray-100 text-gray-500" aria-label="Cerrar" data-action="click->revalidation-wizard#close">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <div class="px-6 pt-5 pb-4 border-b border-gray-100 flex-shrink-0">
      <div class="space-y-3">
        <div class="relative flex items-center justify-between" aria-hidden="true">
          <div class="absolute left-0 right-0 h-1 bg-gray-200 rounded-full"></div>
          <div class="absolute left-0 h-1 bg-indigo-600 rounded-full transition-all duration-300" data-revalidation-wizard-target="progressFill" style="width: 33%"></div>
          <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold text-white bg-indigo-600 shadow relative z-10" data-revalidation-wizard-target="stepBadgeOne">1</span>
          <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold text-indigo-600 bg-indigo-50 border border-indigo-200 relative z-10" data-revalidation-wizard-target="stepBadgeTwo">2</span>
          <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold text-indigo-600 bg-indigo-50 border border-indigo-200 relative z-10" data-revalidation-wizard-target="stepBadgeThree">3</span>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <div class="flex flex-col items-start gap-1">
            <span class="text-sm font-semibold text-gray-900">Cliente</span>
            <p class="text-xs text-gray-500">Confirma Cliente a Facturar.</p>
          </div>
          <div class="flex flex-col items-center gap-1 text-center">
            <span class="text-sm font-semibold text-gray-900">Documentos</span>
            <p class="text-xs text-gray-500">Carga los archivos requeridos.</p>
          </div>
          <div class="flex flex-col items-end gap-1 text-right">
            <span class="text-sm font-semibold text-gray-900">Enviar revalidaci贸n</span>
            <p class="text-xs text-gray-500">Env铆a cuando adjuntes todo.</p>
          </div>
        </div>
      </div>
    </div>

    <% if bl_house_line.errors.any? %>
      <div class="px-6 py-3 bg-red-50 text-sm text-red-700 border-b border-red-100 flex-shrink-0">
        <p class="font-semibold mb-1">No pudimos guardar los cambios:</p>
        <ul class="list-disc list-inside space-y-0.5">
          <% bl_house_line.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="flex-1 overflow-y-auto">
      <div class="p-6 space-y-6">
      <%= form_with model: bl_house_line, url: customs_agents_revalidation_update_path(bl_house_line), method: :patch, data: { turbo_frame: "revalidation_modal" }, html: { multipart: true, class: "space-y-6" } do |form| %>
        <div data-revalidation-wizard-target="stepOne" class="space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="p-4 rounded-2xl border border-indigo-100 bg-indigo-50/70 shadow-md shadow-indigo-100 ring-1 ring-indigo-100">
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Facturar a:</p>
              <%= form.select :client_id,
                              options_from_collection_for_select(clients, :id, :name, bl_house_line.client_id),
                              { include_blank: "Selecciona cliente" },
                              class: "mt-1 block w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500",
                              disabled: bl_house_line.persisted? && bl_house_line.client_id.present?,
                              required: true,
                              data: { revalidation_wizard_target: "clientSelect" } %>
              <p class="mt-1 text-xs text-red-600 hidden" data-revalidation-wizard-target="clientError">Selecciona un cliente antes de continuar.</p>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="p-3 rounded-xl border border-indigo-50 bg-white shadow-sm shadow-indigo-50 ring-1 ring-indigo-50">
              <p class="text-xs text-gray-500">Contenedor</p>
              <p class="text-sm font-semibold text-gray-900"><%= bl_house_line.container&.number || 'Sin contenedor' %></p>
            </div>
            <div class="p-3 rounded-xl border border-indigo-50 bg-white shadow-sm shadow-indigo-50 ring-1 ring-indigo-50">
              <p class="text-xs text-gray-500">Partida</p>
              <p class="text-sm font-semibold text-gray-900"><%= bl_house_line.partida %></p>
            </div>
            <div class="p-3 rounded-xl border border-indigo-50 bg-white shadow-sm shadow-indigo-50 ring-1 ring-indigo-50">
              <p class="text-xs text-gray-500">Estado actual</p>
              <p class="text-sm font-semibold text-gray-900"><%= bl_house_line_status_nombre(bl_house_line.status) %></p>
            </div>
          </div>

          <div class="flex items-center justify-between gap-3">
            <p class="text-sm text-gray-600">Confirma o ajusta cliente antes de subir documentos.</p>
            <button type="button" class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-sm hover:bg-indigo-700 transition" data-action="click->revalidation-wizard#goToDocuments">
              Continuar a documentos
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5-5 5M6 5h6" />
              </svg>
            </button>
          </div>
        </div>

        <div data-revalidation-wizard-target="stepTwo" class="space-y-4 hidden">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-base font-semibold text-gray-900">Documentos requeridos</p>
              <p class="text-sm text-gray-600">Sube los archivos en este paso.</p>
            </div>
            <button type="button" class="text-sm text-indigo-700 hover:text-indigo-900" data-action="click->revalidation-wizard#goToSummary">Volver al paso 1</button>
          </div>

          <% document_labels = {
               bl_endosado_documento: "BL endosado",
               liberacion_documento: "Liberaci贸n",
               encomienda_documento: "Encomienda",
               pago_documento: "Pago"
             } %>
          <% required_docs = bl_house_line.required_revalidation_documents %>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <% required_docs.each do |doc_field| %>
              <% label = document_labels[doc_field] || doc_field.to_s.humanize %>
              <% attachment = bl_house_line.public_send(doc_field) %>
              <% validated = bl_house_line.document_validated?(doc_field) %>

              <div class="p-4 rounded-2xl border border-sky-100 bg-sky-50/60 shadow-md shadow-sky-100 ring-1 ring-sky-100">
                <%= form.label doc_field, label, class: "block text-sm font-semibold text-gray-800 mb-1" %>

                <% if validated %>
                  <div class="flex items-start gap-2 rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-emerald-700">
                    <span class="mt-1 inline-block h-2 w-2 rounded-full bg-emerald-500"></span>
                    <div class="text-xs font-semibold">Documento validado por ejecutivo/admin.</div>
                  </div>
                  <% if attachment.attached? %>
                    <div class="mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-50 text-green-800 text-xs font-semibold border border-green-200">
                      <span class="inline-block w-2 h-2 rounded-full bg-green-500"></span>
                      Cargado
                      <%= link_to "Ver", rails_blob_path(attachment, disposition: "inline"), target: "_blank", class: "underline text-green-800" %>
                    </div>
                  <% end %>
                <% else %>
                  <%= form.file_field doc_field, direct_upload: true, class: "block w-full text-sm text-gray-900 border border-gray-200 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-50 file:text-indigo-700 file:font-semibold file:cursor-pointer hover:file:bg-indigo-100" %>
                  <% if attachment.attached? %>
                    <div class="mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-50 text-green-800 text-xs font-semibold border border-green-200">
                      <span class="inline-block w-2 h-2 rounded-full bg-green-500"></span>
                      Cargado
                      <%= link_to "Ver", rails_blob_path(attachment, disposition: "inline"), target: "_blank", class: "underline text-green-800" %>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>

          <div class="flex items-start justify-between gap-4 p-4 rounded-xl bg-indigo-50 border border-indigo-100">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-indigo-600 text-white flex items-center justify-center"></div>
              <div>
                <p class="text-sm font-semibold text-indigo-900">Revisaremos y confirmaremos tu revalidaci贸n</p>
                <p class="text-xs text-indigo-800">Puedes cerrar el modal y seguir trabajando en el dashboard.</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <%= form.submit "Solicitar Revalidaci贸n", class: "inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-sm hover:bg-indigo-700 transition cursor-pointer" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
</turbo-frame>
