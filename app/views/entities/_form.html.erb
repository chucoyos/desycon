<%= form_with(model: entity, class: "space-y-6") do |form| %>
  <%= render "shared/error_messages", object: entity %>

  <!-- Basic Information -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-4 sm:px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
      <h3 class="text-base sm:text-lg font-semibold text-gray-900">Información Básica</h3>
    </div>
    <div class="px-4 sm:px-6 py-4 space-y-4">
      <!-- Name -->
      <div>
        <%= form.label :name, "Nombre", class: "block text-sm font-semibold text-gray-700 mb-2" %>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
          <%= form.text_field :name, 
              class: "block w-full pl-10 pr-3 py-3 border-2 #{entity.errors[:name].any? ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-200 focus:border-teal-500 focus:ring-teal-500'} rounded-lg focus:ring-2 transition-all duration-200 text-gray-900",
              placeholder: "Nombre de la entidad" %>
        </div>
        <% if entity.errors[:name].any? %>
          <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <%= entity.errors[:name].first %>
          </p>
        <% end %>
      </div>

      <!-- Roles -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-3">Roles</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="relative flex items-start p-4 rounded-lg border-2 cursor-pointer hover:bg-purple-50 transition-colors duration-150 <%= entity.is_consolidator ? 'border-purple-500 bg-purple-50' : 'border-gray-200' %>">
            <%= form.check_box :is_consolidator, class: "h-5 w-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500" %>
            <div class="ml-3">
              <span class="block text-sm font-medium text-gray-900">Consolidador</span>
              <span class="block text-xs text-gray-500">Consolida carga de múltiples clientes</span>
            </div>
          </label>

          <label class="relative flex items-start p-4 rounded-lg border-2 cursor-pointer hover:bg-blue-50 transition-colors duration-150 <%= entity.is_customs_agent ? 'border-blue-500 bg-blue-50' : 'border-gray-200' %>">
            <%= form.check_box :is_customs_agent, class: "h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" %>
            <div class="ml-3">
              <span class="block text-sm font-medium text-gray-900">Agente Aduanal</span>
              <span class="block text-xs text-gray-500">Gestiona trámites aduanales</span>
            </div>
          </label>

          <label class="relative flex items-start p-4 rounded-lg border-2 cursor-pointer hover:bg-green-50 transition-colors duration-150 <%= entity.is_forwarder ? 'border-green-500 bg-green-50' : 'border-gray-200' %>">
            <%= form.check_box :is_forwarder, class: "h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500" %>
            <div class="ml-3">
              <span class="block text-sm font-medium text-gray-900">Forwarder</span>
              <span class="block text-xs text-gray-500">Coordina transporte internacional</span>
            </div>
          </label>

          <label class="relative flex items-start p-4 rounded-lg border-2 cursor-pointer hover:bg-amber-50 transition-colors duration-150 <%= entity.is_client ? 'border-amber-500 bg-amber-50' : 'border-gray-200' %>">
            <%= form.check_box :is_client, class: "h-5 w-5 text-amber-600 border-gray-300 rounded focus:ring-amber-500" %>
            <div class="ml-3">
              <span class="block text-sm font-medium text-gray-900">Cliente</span>
              <span class="block text-xs text-gray-500">Contrata servicios de consolidación</span>
            </div>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Fiscal Profile -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-4 sm:px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
      <h3 class="text-base sm:text-lg font-semibold text-gray-900">Perfil Fiscal</h3>
    </div>
    <div class="px-4 sm:px-6 py-4 space-y-4">
      <% if entity.fiscal_profile %>
        <%= form.fields_for :fiscal_profile do |fp| %>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <%= fp.label :rfc, "RFC", class: "block text-sm font-semibold text-gray-700 mb-2" %>
              <%= fp.text_field :rfc, 
                  class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900",
                  placeholder: "XAXX010101000",
                  maxlength: 13 %>
            </div>

            <div>
              <%= fp.label :razon_social, "Razón Social", class: "block text-sm font-semibold text-gray-700 mb-2" %>
              <%= fp.text_field :razon_social, 
                  class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900",
                  placeholder: "Razón social completa" %>
            </div>

            <div>
              <%= fp.label :regimen, "Régimen Fiscal", class: "block text-sm font-semibold text-gray-700 mb-2" %>
              <%= fp.select :regimen,
                  FiscalProfile::REGIMENES.map { |k, v| ["#{k} - #{v}", k] },
                  { include_blank: "Seleccionar régimen" },
                  class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900" %>
            </div>

            <div>
              <%= fp.label :uso_cfdi, "Uso CFDI", class: "block text-sm font-semibold text-gray-700 mb-2" %>
              <%= fp.select :uso_cfdi,
                  FiscalProfile::USOS_CFDI.map { |k, v| ["#{k} - #{v}", k] },
                  { include_blank: "Seleccionar uso CFDI" },
                  class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900" %>
            </div>

            <div>
              <%= fp.label :forma_pago, "Forma de Pago", class: "block text-sm font-semibold text-gray-700 mb-2" %>
              <%= fp.select :forma_pago,
                  FiscalProfile::FORMAS_PAGO.map { |k, v| ["#{k} - #{v}", k] },
                  { include_blank: "Seleccionar forma de pago" },
                  class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900" %>
            </div>

            <div>
              <%= fp.label :metodo_pago, "Método de Pago", class: "block text-sm font-semibold text-gray-700 mb-2" %>
              <%= fp.select :metodo_pago,
                  FiscalProfile::METODOS_PAGO.map { |k, v| ["#{k} - #{v}", k] },
                  { include_blank: "Seleccionar método de pago" },
                  class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900" %>
            </div>
          </div>
        <% end %>
      <% else %>
        <p class="text-gray-500">No hay perfil fiscal configurado.</p>
      <% end %>
    </div>
  </div>

  <% if entity.persisted? %>
    <!-- Customs Agent Patents -->
    <div id="patents-section" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden" style="<%= 'display: none;' unless entity.is_customs_agent %>">
      <div class="px-4 sm:px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
        <div class="flex items-center justify-between">
        <h3 class="text-base sm:text-lg font-semibold text-gray-900">Patentes Aduanales</h3>
      </div>
    </div>
    <div class="px-4 sm:px-6 py-4">
      <div id="patents-list" class="space-y-2 mb-3">
        <% if entity.persisted? %>
          <% entity.customs_agent_patents.select(&:persisted?).each do |patent| %>
            <%= render partial: "customs_agent_patents/patent", locals: { patent: patent } %>
          <% end %>
        <% end %>
      </div>
      
      <%= turbo_frame_tag "new_patent" %>
      
      <button type="button" 
              id="add-patent-btn"
              onclick="document.getElementById('new_patent').innerHTML = document.getElementById('patent-form-template').innerHTML; this.style.display = 'none';"
              class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
        Agregar Patente
      </button>
      
      <template id="patent-form-template">
        <%= render partial: 'customs_agent_patents/form' %>
      </template>
    </div>
  </div>
  <% end %>

  <!-- Addresses -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-4 sm:px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-base sm:text-lg font-semibold text-gray-900">Direcciones</h3>
      </div>
    </div>
    <div class="px-4 sm:px-6 py-4">
      <% if entity.persisted? %>
        <div id="addresses-list" class="space-y-3 mb-3">
          <% entity.addresses.select(&:persisted?).each do |address| %>
            <%= render partial: "entity_addresses/address", locals: { address: address } %>
          <% end %>
        </div>
        
        <%= turbo_frame_tag "new_address" %>
        
        <button type="button" 
                id="add-address-btn"
                onclick="document.getElementById('new_address').innerHTML = document.getElementById('address-form-template').innerHTML; this.style.display = 'none';"
                class="inline-flex items-center gap-1 px-3 py-1.5 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 transition-colors duration-150">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Agregar Dirección
        </button>
        
        <template id="address-form-template">
          <%= render partial: 'entity_addresses/form' %>
        </template>
      <% else %>
        <% entity.addresses.build %>
        <%= form.fields_for :addresses do |address_form| %>
          <div class="address-field-group p-4 bg-gray-50 rounded-lg border border-gray-200 mb-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <%= address_form.label :tipo, "Tipo *", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= address_form.select :tipo,
                    Address::TIPOS.map { |k, v| [v, k] },
                    { include_blank: "Seleccionar tipo" },
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900" %>
              </div>
              <div>
                <%= address_form.label :email, "Email *", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= address_form.email_field :email,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                    placeholder: "correo@ejemplo.com" %>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3">
              <div class="sm:col-span-2">
                <%= address_form.label :calle, "Calle", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= address_form.text_field :calle,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                    placeholder: "Nombre de la calle" %>
              </div>
              <div>
                <%= address_form.label :numero_exterior, "Núm. Ext.", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= address_form.text_field :numero_exterior,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                    placeholder: "123" %>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 mt-3">
              <div>
                <%= address_form.label :numero_interior, "Núm. Int.", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= address_form.text_field :numero_interior,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                    placeholder: "A" %>
              </div>
              <div>
                <%= address_form.label :colonia, "Colonia", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= address_form.text_field :colonia,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                    placeholder: "Colonia" %>
              </div>
              <div>
                <%= address_form.label :codigo_postal, "CP *", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= address_form.text_field :codigo_postal,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                    placeholder: "12345" %>
              </div>
              <div>
                <%= address_form.label :pais, "País *", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= address_form.text_field :pais,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                    value: "MX",
                    maxlength: 2 %>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
              <div>
                <%= address_form.label :municipio, "Municipio", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= address_form.text_field :municipio,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                    placeholder: "Municipio" %>
              </div>
              <div>
                <%= address_form.label :estado, "Estado *", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= address_form.text_field :estado,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                    placeholder: "Estado" %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="flex items-center gap-3 pt-4">
    <%= form.submit entity.persisted? ? 'Actualizar Entidad' : 'Crear Entidad',
        class: "inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-teal-600 to-cyan-700 hover:from-teal-700 hover:to-cyan-800 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-200 font-semibold cursor-pointer" %>
    <%= link_to "Cancelar", entities_path,
        class: "inline-flex items-center justify-center gap-2 px-6 py-3 bg-white text-gray-700 rounded-lg shadow-sm border border-gray-300 hover:bg-gray-50 transition-all duration-200 font-semibold" %>
  </div>
<% end %>