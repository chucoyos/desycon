<%= form_with(model: entity, class: "space-y-6", data: { controller: "entity-form" }) do |form| %>
  <%= render "shared/error_messages", object: entity %>

  <!-- Basic Information -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-4 sm:px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
      <h3 class="text-base sm:text-lg font-semibold text-gray-900">Información Básica</h3>
    </div>
    <div class="px-4 sm:px-6 py-4 space-y-4">
      <!-- Name -->
      <div>
        <%= form.label :name, "Nombre", class: "block text-sm font-semibold text-gray-700 mb-2" %>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
          <%= form.text_field :name, 
              class: "block w-full pl-10 pr-3 py-3 border-2 #{entity.errors[:name].any? ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-200 focus:border-teal-500 focus:ring-teal-500'} rounded-lg focus:ring-2 transition-all duration-200 text-gray-900",
              placeholder: "Nombre de la entidad" %>
        </div>
        <% if entity.errors[:name].any? %>
          <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <%= entity.errors[:name].first %>
          </p>
        <% end %>
      </div>

      <!-- Roles -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-3">Roles</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="relative flex items-start p-4 rounded-lg border-2 cursor-pointer hover:bg-purple-50 transition-colors duration-150 <%= entity.is_consolidator ? 'border-purple-500 bg-purple-50' : 'border-gray-200' %>">
            <%= form.check_box :is_consolidator, class: "h-5 w-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500" %>
            <div class="ml-3">
              <span class="block text-sm font-medium text-gray-900">Consolidador</span>
              <span class="block text-xs text-gray-500">Consolida carga de múltiples clientes</span>
            </div>
          </label>

          <label class="relative flex items-start p-4 rounded-lg border-2 cursor-pointer hover:bg-blue-50 transition-colors duration-150 <%= entity.is_customs_agent ? 'border-blue-500 bg-blue-50' : 'border-gray-200' %>">
            <%= form.check_box :is_customs_agent, class: "h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500", data: { action: "change->entity-form#togglePatents" } %>
            <div class="ml-3">
              <span class="block text-sm font-medium text-gray-900">Agente Aduanal</span>
              <span class="block text-xs text-gray-500">Gestiona trámites aduanales</span>
            </div>
          </label>

          <label class="relative flex items-start p-4 rounded-lg border-2 cursor-pointer hover:bg-green-50 transition-colors duration-150 <%= entity.is_forwarder ? 'border-green-500 bg-green-50' : 'border-gray-200' %>">
            <%= form.check_box :is_forwarder, class: "h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500" %>
            <div class="ml-3">
              <span class="block text-sm font-medium text-gray-900">Forwarder</span>
              <span class="block text-xs text-gray-500">Coordina transporte internacional</span>
            </div>
          </label>

          <label class="relative flex items-start p-4 rounded-lg border-2 cursor-pointer hover:bg-amber-50 transition-colors duration-150 <%= entity.is_client ? 'border-amber-500 bg-amber-50' : 'border-gray-200' %>">
            <%= form.check_box :is_client, class: "h-5 w-5 text-amber-600 border-gray-300 rounded focus:ring-amber-500" %>
            <div class="ml-3">
              <span class="block text-sm font-medium text-gray-900">Cliente</span>
              <span class="block text-xs text-gray-500">Contrata servicios de consolidación</span>
            </div>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Fiscal Profile -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-4 sm:px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
      <h3 class="text-base sm:text-lg font-semibold text-gray-900">Perfil Fiscal</h3>
    </div>
    <div class="px-4 sm:px-6 py-4 space-y-4">
      <%= form.fields_for :fiscal_profile do |fp| %>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <%= fp.label :rfc, "RFC", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%= fp.text_field :rfc, 
                class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900",
                placeholder: "XAXX010101000",
                maxlength: 13 %>
          </div>

          <div>
            <%= fp.label :razon_social, "Razón Social", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%= fp.text_field :razon_social, 
                class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900",
                placeholder: "Razón social completa" %>
          </div>

          <div>
            <%= fp.label :regimen, "Régimen Fiscal", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%= fp.select :regimen,
                FiscalProfile::REGIMENES.map { |k, v| ["#{k} - #{v}", k] },
                { include_blank: "Seleccionar régimen" },
                class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900" %>
          </div>

          <div>
            <%= fp.label :uso_cfdi, "Uso CFDI", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%= fp.select :uso_cfdi,
                FiscalProfile::USOS_CFDI.map { |k, v| ["#{k} - #{v}", k] },
                { include_blank: "Seleccionar uso CFDI" },
                class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900" %>
          </div>

          <div>
            <%= fp.label :forma_pago, "Forma de Pago", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%= fp.select :forma_pago,
                FiscalProfile::FORMAS_PAGO.map { |k, v| ["#{k} - #{v}", k] },
                { include_blank: "Seleccionar forma de pago" },
                class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900" %>
          </div>

          <div>
            <%= fp.label :metodo_pago, "Método de Pago", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%= fp.select :metodo_pago,
                FiscalProfile::METODOS_PAGO.map { |k, v| ["#{k} - #{v}", k] },
                { include_blank: "Seleccionar método de pago" },
                class: "block w-full px-3 py-3 border-2 border-gray-200 focus:border-teal-500 focus:ring-teal-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Customs Agent Patents -->
  <div id="patents-section" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden" style="<%= 'display: none;' unless entity.is_customs_agent %>">
    <div class="px-4 sm:px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-base sm:text-lg font-semibold text-gray-900">Patentes Aduanales</h3>
        <button type="button" class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-150" data-action="click->entity-form#addPatent">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Agregar
        </button>
      </div>
    </div>
    <div class="px-4 sm:px-6 py-4" id="patents-container">
      <%= form.fields_for :customs_agent_patents do |patent_form| %>
        <div class="patent-field-group flex items-center gap-2 mb-3">
          <%= patent_form.text_field :patent_number, 
              class: "flex-1 px-3 py-2 border-2 border-gray-200 focus:border-blue-500 focus:ring-blue-500 rounded-lg focus:ring-2 transition-all duration-200 text-gray-900",
              placeholder: "Número de patente" %>
          <%= patent_form.check_box :_destroy, class: "hidden" %>
          <button type="button" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-150" data-action="click->entity-form#removePatent">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
            </svg>
          </button>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Addresses -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-4 sm:px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-base sm:text-lg font-semibold text-gray-900">Direcciones</h3>
        <button type="button" class="inline-flex items-center gap-1 px-3 py-1.5 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 transition-colors duration-150" data-action="click->entity-form#addAddress">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Agregar
        </button>
      </div>
    </div>
    <div class="px-4 sm:px-6 py-4 space-y-4" id="addresses-container">
      <%= form.fields_for :addresses do |address_form| %>
        <div class="address-field-group p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-sm font-semibold text-gray-700">Dirección</h4>
            <%= address_form.check_box :_destroy, class: "hidden" %>
            <button type="button" class="p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-150" data-action="click->entity-form#removeAddress">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="sm:col-span-2">
              <%= address_form.label :calle, "Calle", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.text_field :calle, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                  placeholder: "Calle y número" %>
            </div>
            <div>
              <%= address_form.label :numero_exterior, "Número Exterior", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.text_field :numero_exterior, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                  placeholder: "Núm. Ext." %>
            </div>
            <div>
              <%= address_form.label :numero_interior, "Número Interior", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.text_field :numero_interior, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                  placeholder: "Núm. Int." %>
            </div>
            <div>
              <%= address_form.label :colonia, "Colonia", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.text_field :colonia, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                  placeholder: "Colonia" %>
            </div>
            <div>
              <%= address_form.label :municipio, "Municipio", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.text_field :municipio, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                  placeholder: "Municipio" %>
            </div>
            <div>
              <%= address_form.label :localidad, "Localidad", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.text_field :localidad, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                  placeholder: "Localidad" %>
            </div>
            <div>
              <%= address_form.label :estado, "Estado", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.text_field :estado, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                  placeholder: "Estado" %>
            </div>
            <div>
              <%= address_form.label :codigo_postal, "Código Postal", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.text_field :codigo_postal, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                  placeholder: "CP" %>
            </div>
            <div>
              <%= address_form.label :pais, "País", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.text_field :pais, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                  placeholder: "MX" %>
            </div>
            <div>
              <%= address_form.label :email, "Email", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.email_field :email, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900",
                  placeholder: "email@ejemplo.com" %>
            </div>
            <div>
              <%= address_form.label :tipo, "Tipo", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= address_form.select :tipo, 
                  Address::TIPOS.map { |k, v| [v, k] },
                  { include_blank: "Seleccionar tipo" },
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-teal-500 focus:ring-teal-500 text-gray-900" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="flex items-center gap-3 pt-4">
    <%= form.submit class: "inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-teal-600 to-cyan-700 hover:from-teal-700 hover:to-cyan-800 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-200 font-semibold cursor-pointer" do %>
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <%= entity.persisted? ? 'Actualizar Entidad' : 'Crear Entidad' %>
    <% end %>
    <%= link_to entities_path, class: "inline-flex items-center justify-center gap-2 px-6 py-3 bg-white text-gray-700 rounded-lg shadow-sm border border-gray-300 hover:bg-gray-50 transition-all duration-200 font-semibold" do %>
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
      Cancelar
    <% end %>
  </div>
<% end %>
