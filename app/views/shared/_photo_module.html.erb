<%
  photos = attachable.photos.for_section(section).recent.with_attached_image.limit(24)
  total_photos = attachable.photos.for_section(section).count
  upload_path = attachable.is_a?(Container) ? photos_container_path(attachable) : photos_bl_house_line_path(attachable)
%>

<section class="bg-white shadow-sm rounded-xl p-5 border border-gray-100">
  <div class="flex items-center justify-between gap-3 mb-4">
    <div>
      <h3 class="text-base font-bold text-gray-900"><%= title %></h3>
      <p class="text-xs text-gray-500"><%= subtitle %> · <%= total_photos %> foto(s)</p>
    </div>
  </div>

  <%= form_with url: upload_path, method: :post, multipart: true, class: "space-y-3" do |f| %>
    <%= f.hidden_field :section, value: section, name: "photo[section]" %>

    <label class="block text-sm font-medium text-gray-700">Cargar fotografías</label>
    <%= f.file_field :images,
          name: "photo[images][]",
          multiple: true,
          direct_upload: true,
          accept: "image/*",
          class: "block w-full text-sm text-gray-700 file:mr-3 file:rounded-md file:border-0 file:bg-blue-600 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-white hover:file:bg-blue-700" %>

    <p class="text-xs text-gray-500">Sugerido para móvil: subir en lotes de 5 a 10 imágenes por envío.</p>

    <div>
      <%= f.submit "Subir", class: "w-full sm:w-auto inline-flex justify-center items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700" %>
    </div>
  <% end %>

  <div class="mt-4">
    <% if photos.any? %>
      <div class="grid grid-cols-3 gap-2 sm:grid-cols-4 lg:grid-cols-5">
        <% photos.each do |photo| %>
          <div class="relative rounded-lg border border-gray-200 overflow-hidden bg-gray-50">
            <%= link_to rails_blob_path(photo.image, disposition: "inline"), target: "_blank", class: "block" do %>
              <% if photo.image.variable? %>
                <%= image_tag photo.image.variant(resize_to_limit: [ 320, 320 ]), class: "h-24 w-full object-cover", loading: "lazy" %>
              <% else %>
                <%= image_tag photo.image, class: "h-24 w-full object-cover", loading: "lazy" %>
              <% end %>
            <% end %>

            <% if policy(photo).destroy? %>
              <div class="absolute top-1 right-1">
                <%= button_to photo_path(photo), method: :delete,
                      form: { data: { turbo_confirm: "¿Eliminar esta fotografía?" } },
                      class: "rounded-md bg-white/90 px-2 py-1 text-[11px] font-medium text-red-700 shadow-sm" do %>
                  Eliminar
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if total_photos > photos.size %>
        <p class="mt-2 text-xs text-gray-500">Mostrando <%= photos.size %> de <%= total_photos %> fotos.</p>
      <% end %>
    <% else %>
      <p class="text-sm text-gray-500">Sin fotografías en esta sección.</p>
    <% end %>
  </div>
</section>